---
layout: post
title: "[Oracle] 16. SQL - hierachy connect_by_isleaf, connect_by_root"
date: 2022-02-19 12:00:00 +0900
category: oracle
---

# 1. connect_by_isLeaf

leaf은 나무의 잎이다.

잎이 있으면 '1' 아니면 '0'을 나타낸다.

### IsLeafT

| id | parentId |
| :--- | :--- |
| 1 | null |
| 2 | 1 |
| 3 | 2 |
| 4 | 1 |
| 5 | 4 |
| 6 | 4 |
| 7 | 1 |
| 10 | null |
| 20 | null |
| 21 | 20 |
| 22 | 21 |

```sql
select id,
       parentId,
       level,
       connect_by_isleaf as isleaf,
       sys_connect_by_path(to_char(id), ',') as path
from isLeafT
start with parentId is null
connect by prior id = parentId
```

### 출력결과

| id | parentId | level | isLeaf | path |
| :--- | :--- | :--- | :--- | :--- |
| 1 | null | 1 | 0 | ,1 |
| 2 | 1 | 2 | 0 | ,1,2 |
| 3 | 2 | 3 | 1 | ,1,2,3 |
| 4 | 1 | 2 | 0 | ,1,4 |
| 5 | 4 | 3 | 1 | ,1,4,5 |
| 6 | 4 | 3 | 1 | ,1,4,6 |
| 7 | 1 | 2 | 1 | ,1,7 |
| 10 | null | 1 | 1 | ,10 |
| 20 | null | 1 | 0 | ,20 |
| 21 | 20 | 2 | 0 | ,20,21 |
| 22 | 21 | 3 | 1 | ,20,21,22 |


다음은 where 절에 connect_by_isleaf = 1를 추가해 보자

```sql
select id,
       parentId,
       level,
       sys_connect_by_path(to_char(id), ',') as path
from   isLeafT
where  connect_by_isleaf = 1
start with parentId is null
connect by prior id = parentId
```

### 출력결과

| ID | OyaID | Level | path |
| :--- | :--- | :--- | :--- |
| 3 | 2 | 3 | ,1,2,3 |
| 5 | 4 | 3 | ,1,4,5 |
| 6 | 4 | 3 | ,1,4,6 |
| 7 | 1 | 2 | ,1,7 |
| 10 | null | 1 | ,10 |
| 22 | 21 | 3 | ,20,21,22 |

# 2. connect_by_root

말 그대로 뿌리이므로 root값을 찾고자 할 때 사용한다.

### isRootT

| id | parentId |
| :--- | :--- |
| 1 | null |
| 2 | 1 |
| 3 | 1 |
| 4 | 1 |
| 5 | 3 |
| 6 | 3 |
| 7 | 4 |
| 8 | 4 |
| 9 | 6 |
| 10 | null |
| 20 | null |
| 21 | 20 |
| 22 | 20 |
| 23 | 21 |
| 24 | 21 |

```sql
select id,
       parentId,
       level,
       connect_by_root id as rootId,
       sys_connect_by_path(to_char(ID), ',') as path
from   IsRootT
start with parentId is null
connect by prior id = parentId;
```

### 출력결과

| id | parentId | level | rootId | path |
| :--- | :--- | :--- | :--- | :--- |
| 1 | null | 1 | 1 | ,1 |
| 2 | 1 | 2 | 1 | ,1,2 |
| 3 | 1 | 2 | 1 | ,1,3 |
| 5 | 3 | 3 | 1 | ,1,3,5 |
| 6 | 3 | 3 | 1 | ,1,3,6 |
| 9 | 6 | 4 | 1 | ,1,3,6,9 |
| 4 | 1 | 2 | 1 | ,1,4 |
| 7 | 4 | 3 | 1 | ,1,4,7 |
| 8 | 4 | 3 | 1 | ,1,4,8 |
| 10 | null | 1 | 10 | ,10 |
| 20 | null | 1 | 20 | ,20 |
| 21 | 20 | 2 | 20 | ,20,21 |
| 23 | 21 | 3 | 20 | ,20,21,23 |
| 24 | 21 | 3 | 20 | ,20,21,24 |
| 22 | 20 | 2 | 20 | ,20,22 |

다음은 폭우선순으로 정렬해보자

```sql
select id,
       parentId,
       level,
       sys_connect_by_path(to_char(ID), ',') as path
from   IsRootT
start with parentId is null
connect by prior id = parentId
order by connect_by_root id, level, path;
```

### 출력결과

| id | parentId | level | path |
| :--- | :--- | :--- | :--- |
| 1 | null | 1 | ,1 |
| 2 | 1 | 2 | ,1,2 |
| 3 | 1 | 2 | ,1,3 |
| 4 | 1 | 2 | ,1,4 |
| 5 | 3 | 3 | ,1,3,5 |
| 6 | 3 | 3 | ,1,3,6 |
| 7 | 4 | 3 | ,1,4,7 |
| 8 | 4 | 3 | ,1,4,8 |
| 9 | 6 | 4 | ,1,3,6,9 |
| 10 | null | 1 | ,10 |
| 20 | null | 1 | ,20 |
| 21 | 20 | 2 | ,20,21 |
| 22 | 20 | 2 | ,20,22 |
| 23 | 21 | 3 | ,20,21,23 |
| 24 | 21 | 3 | ,20,21,24 |


# 3 prior 연산자

주로 connect by 절에 사용하지만, select 절에 사용하면 상위 행의 값을 얻을 수 있다.

### priorT

| id | parentId | name |
| :--- | :--- | :--- |
| 1 | null | AAAA |
| 2 | 1 | BBBB |
| 3 | 2 | CCCC |
| 4 | 1 | DDDD |
| 5 | 4 | EEEE |
| 6 | 4 | FFFF |
| 7 | 1 | GGGG |
| 10 | null | HHHH |
| 20 | null | IIII |
| 21 | 20 | JJJJ |
| 22 | 21 | KKKK |

```sql
select id,
       parentId,
       name,
       prior name as parentName,
       level,
       sys_connect_by_path(to_char(ID),',') as path
from   priorT
start with parentId is null
connect by prior id = parentId;
```