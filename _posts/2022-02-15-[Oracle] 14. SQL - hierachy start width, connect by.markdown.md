---
layout: post
title: "[Oracle] 14. SQL - hierachy start with, connect by"
date: 2022-02-15 16:00:00 +0900
category: oracle
---

# 1. hierachy start with, connect by

### IDTable

| id | parentId |
| :--- | :--- |
| 1 | null |
| 2 | 1 |
| 3 | 2 |
| 4 | 3 |
| 5 | 1 |
| 6 | 5 |
| 7 | 2 |
| 20 | null |
| 21 | 20 |
| 22 | 21 |

### 기본적인 계층조회

```sql
select  id, parentId, level
from    IDTable
start   with parentId is null
connect by prior id = parentId
```

### 출력결과

| id | parentId | level |
| :--- | :--- | :--- |
| 1 | null | 1 |
| 2 | 1 | 2 |
| 3 | 2 | 3 |
| 4 | 3 | 4 |
| 7 | 2 | 3 |
| 5 | 1 | 2 |
| 6 | 5 | 3 |
| 20 | null | 1 |
| 21 | 20 | 2 |
| 22 | 21 | 3 |

start with절에서, 시작 조건을 지정한다.

parentId is null를 만족하는 것은, id가 1과 20이다.

connect by절에서 계층관계의 조건을 지정합니다.

prior Id = parentId는 (상위) id = (하위) parentId라는 의미가 된다.


# 2. connect by절 복수조건

connect by절에서 복수의 조건을 지정할 수 있다.

| id | seq |
| :---: | :---: |
| 1 | 1 |
| 1 | 2 |
| 1 | 3 |
| 3 | 1|
| 4 | 1 |
| 4 | 3 |
| 5 | 1 |
| 5 | 2 |
| 5 | 3 |

seq = 1 행을 시작으로 계층관계 조건을 같은 id로 하고 하위 seq이 상위보다 1큰 것으로 한다.

```sql
select id, seq, level
from   SeqT
start with seq = 1
connect by prior id = id and prior seq = seq - 1
```

### 출력결과

| id | seq | level |
| :---: | :---: | :---: |
| 1 | 1 | 1 |
| 1 | 2 | 2 |
| 1 | 3 | 3 |
| 3 | 1 | 1 |
| 4 | 1 | 1 |
| 5 | 1 | 1 |
| 5 | 2 | 2 |
| 5 | 3 | 3 |


start with절에서 시작점을 지정합니다

seq = 1을 만족하는 행이, 시작점이 됩니다.

그리고 connect by절에서 지정한 계층관계 조건을만족하면 계층관계가 된다.

### 계층관계 조건

```sql
    prior id = id
amd prior seq = seq - 1
```

# 3. start width절 생략

start with 절을 생략하고 계층관계를 만들 수 있다.

### valT

| val |
| :---: |
| 1 |
| 2 |
| 3 |
| 4 |
| 5 |

```sql
select val, level, sys_connect_by_path(to_char(val), ',') as path
from   valT
connect by prior val = val - 1;
```

### 출력결과

| val | level | path |
| :---: | :---: | :--- |
| 1 | 1 | ,1 |
| 2 | 2 | ,1,2 |
| 3 | 3 | ,1,2,3 |
| 4 | 4 | ,1,2,3,4 |
| 5 | 5 | ,1,2,3,4,5 |
| 2 | 1 | ,2 |
| 3 | 2 | ,2,3 |
| 4 | 3 | ,2,3,4 |
| 5 | 4 | ,2,3,4,5 |
| 3 | 1 | ,3 |
| 4 | 2 | ,3,4 |
| 5 | 3 | ,3,4,5 |
| 4 | 1 | ,4 |
| 5 | 2 | ,4,5 |
| 5 | 1 | ,5 |

start with절이 생략되었으므로, 모든 행이 시작점이 된다.

select절에서 sys_connect_by_path함수를 사용해서, 경로를 표시할 수 있다.